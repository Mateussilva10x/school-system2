<div class="container mx-auto p-4">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Notas dos Alunos</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Filters Form -->
      <form [formGroup]="filterForm" (ngSubmit)="onSearch()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Class Select -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Turma</mat-label>
          <mat-select formControlName="classId">
            <mat-option value="">Selecione uma turma</mat-option>
            <mat-option *ngFor="let class of classes" [value]="class.uniqueId">
              {{class.name}}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="filterForm.get('classId')?.hasError('required')">
            Turma é obrigatória
          </mat-error>
        </mat-form-field>

        <!-- School Year Input -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Ano Letivo</mat-label>
          <mat-select formControlName="schoolYear">
            <mat-option value="">Selecione um ano Letivo</mat-option>
            <mat-option *ngFor="let schoolYear of schoolYears" [value]="schoolYear">
              {{schoolYear}}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="filterForm.get('schoolYear')?.hasError('required')">
            Ano letivo é obrigatório
          </mat-error>
          <mat-error *ngIf="filterForm.get('schoolYear')?.hasError('min') || filterForm.get('schoolYear')?.hasError('max')">
            Ano deve estar entre 2000 e 2100
          </mat-error>
        </mat-form-field>

        <!-- Subject Select -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Matéria</mat-label>
          <mat-select formControlName="subjectId">
            <mat-option value="">Selecione uma matéria</mat-option>
            <mat-option *ngFor="let subject of subjects" [value]="subject.uniqueId">
              {{subject.name}}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="filterForm.get('subjectId')?.hasError('required')">
            Matéria é obrigatória
          </mat-error>
        </mat-form-field>

        <!-- Bimester Select -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Bimestre</mat-label>
          <mat-select formControlName="bimester">
            <mat-option value="">Selecione um bimestre</mat-option>
            <mat-option *ngFor="let bimester of bimesters" [value]="bimester">
              {{bimester}} Bimestre
            </mat-option>
          </mat-select>
          <mat-error *ngIf="filterForm.get('bimester')?.hasError('required')">
            Bimestre é obrigatório
          </mat-error>
        </mat-form-field>

        <!-- Search Button -->
        <div class="col-span-full flex justify-end mt-4">
          <button mat-raised-button color="primary" type="submit" [disabled]="!filterForm.valid || isLoading">
            <span *ngIf="!isLoading">Buscar</span>
            <span *ngIf="isLoading">Carregando...</span>
          </button>
        </div>
      </form>

      <!-- Message when no filters are selected -->
      <div *ngIf="!showTable" class="text-center py-8">
        <p class="text-gray-600">
          Selecione os filtros acima para visualizar as notas dos alunos.
        </p>
      </div>

      <!-- Grades Table -->
      <div *ngIf="showTable" class="overflow-x-auto mt-6">
        <table mat-table [dataSource]="students" class="w-full">
          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef class="bg-gray-50 font-bold"> Aluno </th>
            <td mat-cell *matCellDef="let student"> {{student.name}} </td>
          </ng-container>

          <!-- P1 Column -->
          <ng-container matColumnDef="p1">
            <th mat-header-cell *matHeaderCellDef class="text-center bg-gray-50 font-bold"> P1 </th>
            <td mat-cell *matCellDef="let student">
              <form [formGroup]="gradesForm" class="w-full mt-8">
                <mat-form-field appearance="fill" class="w-20">
                  <input matInput type="number" min="0" max="10" step="0.1"
                         formControlName="p1"
                         [value]="getStudentGrade(student.uniqueId, 'p1')">
                </mat-form-field>
              </form>
            </td>
          </ng-container>

          <!-- P2 Column -->
          <ng-container matColumnDef="p2">
            <th mat-header-cell *matHeaderCellDef class="text-center bg-gray-50 font-bold"> P2 </th>
            <td mat-cell *matCellDef="let student">
              <form [formGroup]="gradesForm" class="w-full mt-8">
                <mat-form-field appearance="fill" class="w-20">
                  <input matInput type="number" min="0" max="10" step="0.1"
                         formControlName="p2"
                         [value]="getStudentGrade(student.uniqueId, 'p2')">
                </mat-form-field>
              </form>
            </td>
          </ng-container>

          <!-- Average Column -->
          <ng-container matColumnDef="average">
            <th mat-header-cell *matHeaderCellDef class="text-center bg-gray-50 font-bold"> Média </th>
            <td mat-cell *matCellDef="let student" class="text-center">
              <span [class.text-red-500]="calculateAverage(gradesForm.get('p1')?.value || 0, gradesForm.get('p2')?.value || 0) < 6">
                {{calculateAverage(gradesForm.get('p1')?.value || 0, gradesForm.get('p2')?.value || 0) | number:'1.1-1'}}
              </span>
            </td>
          </ng-container>

          <!-- Recovery Column -->
          <ng-container matColumnDef="recovery">
            <th mat-header-cell *matHeaderCellDef class="text-center bg-gray-50 font-bold"> Recuperação </th>
            <td mat-cell *matCellDef="let student">
              <form [formGroup]="gradesForm" class="w-full mt-8">
                <mat-form-field appearance="fill" class="w-20">
                  <mat-label>Rec</mat-label>
                  <input matInput type="number" formControlName="rec" min="0" max="10" step="0.1"
                         [value]="getStudentGrade(student.uniqueId, 'rec')"
                         [disabled]="!needsRecovery(calculateAverage(
                          gradesForm.get('p1')?.value || 0,
                          gradesForm.get('p2')?.value || 0
                        ))">
                </mat-form-field>
              </form>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-center bg-gray-50 font-bold"> Ações </th>
            <td mat-cell *matCellDef="let student">
              <button mat-mini-fab color="primary" class="save-button"
                      (click)="saveGrade(student, gradesForm.get('p1')?.value, gradesForm.get('p2')?.value, gradesForm.get('rec')?.value)"
                      [disabled]="isLoading">
                <mat-icon>save</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['name', 'p1', 'p2', 'average', 'recovery', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['name', 'p1', 'p2', 'average', 'recovery', 'actions'];"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>
